@model LebAssist.Presentation.ViewModels.Booking.CreateBookingViewModel
@using Microsoft.Extensions.Options
@using LebAssist.Application.Common
@inject IOptions<GoogleMapsSettings> GoogleMapsSettings

@{
    ViewData["Title"] = "Book Service";
    var provider = ViewBag.Provider;
    var service = ViewBag.Service;
    var workingHours = ViewBag.WorkingHours ?? new List<object>();
    var apiKey = GoogleMapsSettings.Value.ApiKey;
    var initialLat = Model.Latitude != 0 ? Model.Latitude : 33.8938;
    var initialLng = Model.Longitude != 0 ? Model.Longitude : 35.5018;
}

<div class="booking-page">
    <!-- Header Section -->
    <div class="page-header">
        <div class="container">
            <!-- Breadcrumb -->
            <nav class="custom-breadcrumb" aria-label="breadcrumb">
                <ol class="breadcrumb-list">
                    <li class="breadcrumb-item">
                        <a href="@Url.Action("Index", "Services")">
                            <i class="bi bi-house-door"></i>
                            Services
                        </a>
                    </li>
                    <li class="breadcrumb-separator">
                        <i class="bi bi-chevron-right"></i>
                    </li>
                    <li class="breadcrumb-item">
                        <a href="@Url.Action("Details", "Services", new { id = Model.ServiceId })">
                            @service?.ServiceName
                        </a>
                    </li>
                    <li class="breadcrumb-separator">
                        <i class="bi bi-chevron-right"></i>
                    </li>
                    <li class="breadcrumb-item active">
                        Book Service
                    </li>
                </ol>
            </nav>

            <!-- Page Title -->
            <div class="page-title-section">
                <h1 class="page-title">
                    <i class="bi bi-calendar-check"></i>
                    Book Your Service
                </h1>
                <p class="page-subtitle">Complete the form below to schedule your appointment</p>
            </div>
        </div>
    </div>

    <!-- Booking Form Section -->
    <div class="container booking-content">
        <div class="booking-wrapper">
            <form id="bookingForm" asp-action="Create" method="post" class="booking-form">
                <div asp-validation-summary="ModelOnly" class="alert alert-danger custom-alert"></div>

                <input type="hidden" asp-for="ProviderId" />
                <input type="hidden" asp-for="ServiceId" />
                <input type="hidden" asp-for="BookingDateTime" id="BookingDateTimeHidden" />

                <!-- Provider Schedule Card -->
                <div class="form-section">
                    <div class="section-header">
                        <i class="bi bi-clock-history"></i>
                        <h3>Provider Schedule</h3>
                    </div>
                    <div class="schedule-display">
                        @if (workingHours is IEnumerable<dynamic> whs && whs.Any())
                        {
                            foreach (var wh in whs)
                            {
                                <div class="schedule-table-wrapper">
                                    <table class="schedule-table">
                                        <thead>
                                            <tr>
                                                <th><i class="bi bi-calendar3"></i> Day</th>
                                                <th><i class="bi bi-clock"></i> Start</th>
                                                <th><i class="bi bi-clock-fill"></i> End</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var d in wh.DaySchedules)
                                            {
                                                var dayName = new[]
                                                {
                                                                        "Sunday","Monday","Tuesday",
                                                                        "Wednesday","Thursday","Friday","Saturday"
                                                                        }[d.DayOfWeek];

                                                <tr>
                                                    <td class="day-name">@dayName</td>
                                                    <td>@d.StartTime</td>
                                                    <td>@d.EndTime</td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            }
                        }
                        else
                        {
                            <div class="no-schedule">
                                <i class="bi bi-calendar-x"></i>
                                <span>Provider has no working hours for this service.</span>
                            </div>
                        }
                    </div>
                </div>

                <!-- Date & Time Selection -->
                <div class="form-section">
                    <div class="section-header">
                        <i class="bi bi-calendar-event"></i>
                        <h3>Select Date & Time</h3>
                    </div>
                    <div class="datetime-grid">
                        <div class="form-group">
                            <label class="form-label">
                                <i class="bi bi-calendar3"></i>
                                Choose Date
                            </label>
                            <input type="date"
                                   id="bookingDate"
                                   class="form-control"
                                   min="@DateTime.UtcNow.ToString("yyyy-MM-dd")" />
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                <i class="bi bi-clock"></i>
                                Choose Time
                            </label>
                            <select id="bookingTime" class="form-select">
                                <option value="">Select time slot</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Location Selection -->
                <div class="form-section">
                    <div class="section-header">
                        <i class="bi bi-geo-alt"></i>
                        <h3>Service Location</h3>
                    </div>
                    <div class="location-section">
                        <p class="location-instruction">
                            <i class="bi bi-cursor"></i>
                            Click on the map to set your service location
                        </p>

                        <!-- Hidden fields -->
                        <input type="hidden" asp-for="Latitude" id="Latitude" />
                        <input type="hidden" asp-for="Longitude" id="Longitude" />

                        <!-- Map Container -->
                        <div class="map-wrapper">
                            <div id="map" class="map-container"></div>
                        </div>

                        <!-- Coordinates Display -->
                        <div class="coordinates-display">
                            <div class="coordinate-badge">
                                <i class="bi bi-geo-alt-fill"></i>
                                <span>Latitude: <strong id="latText">0</strong></span>
                            </div>
                            <div class="coordinate-badge">
                                <i class="bi bi-geo-fill"></i>
                                <span>Longitude: <strong id="lngText">0</strong></span>
                            </div>
                        </div>

                        <span asp-validation-for="Latitude" class="text-danger"></span>
                    </div>
                </div>

                <!-- Notes Section -->
                <div class="form-section">
                    <div class="section-header">
                        <i class="bi bi-pencil-square"></i>
                        <h3>Additional Notes</h3>
                    </div>
                    <div class="form-group">
                        <label asp-for="Notes" class="form-label">Notes (Optional)</label>
                        <textarea asp-for="Notes" class="form-control" rows="4"
                                  placeholder="Add any special instructions or requirements..."></textarea>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-calendar-check"></i>
                        Confirm Booking
                    </button>
                    <a asp-controller="Services" asp-action="Index" class="btn btn-secondary">
                        <i class="bi bi-x-circle"></i>
                        Cancel
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Pass values to JavaScript -->
<script>
    var mapConfig = {
        lat: @initialLat.ToString(System.Globalization.CultureInfo.InvariantCulture),
        lng: @initialLng.ToString(System.Globalization.CultureInfo.InvariantCulture),
        apiKey: '@apiKey'
    };
</script>

@section Styles {
    <link rel="stylesheet" href="~/css/bookingCreate.css" />
}

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const workingHours = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(workingHours));

            function parseTime(ts) {
                const p = ts.split(':').map(Number);
                return { h: p[0], m: p[1] };
            }

            function format(h, m) {
                return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
            }

            function generateSlots(start, end) {
                const s = parseTime(start);
                const e = parseTime(end);
                const slots = [];
                let h = s.h, m = s.m;

                while (h < e.h || (h === e.h && m < e.m)) {
                    slots.push(format(h, m));
                    m += 30;
                    if (m >= 60) { m = 0; h++; }
                }
                return slots;
            }

            function getSchedule(dateStr) {
                const d = new Date(dateStr);
                const day = d.getDay();
                const wh = workingHours[0];
                return wh?.DaySchedules?.find(x => x.DayOfWeek === day);
            }

            const bookingDateEl = document.getElementById('bookingDate');
            const bookingTimeEl = document.getElementById('bookingTime');
            const bookingFormEl = document.getElementById('bookingForm');
            const bookingDateTimeHidden = document.getElementById('BookingDateTimeHidden');

            if (bookingDateEl) {
                bookingDateEl.addEventListener('change', e => {
                    if (!bookingTimeEl) return;
                    bookingTimeEl.innerHTML = '<option value="">Select time slot</option>';

                    const sch = getSchedule(e.target.value);
                    if (!sch) return;

                    generateSlots(sch.StartTime, sch.EndTime).forEach(t => {
                        const o = document.createElement('option');
                        o.value = t;
                        o.textContent = t;
                        bookingTimeEl.appendChild(o);
                    });
                });
            }

            if (bookingFormEl) {
                bookingFormEl.addEventListener('submit', e => {
                    const d = bookingDateEl ? bookingDateEl.value : null;
                    const t = bookingTimeEl ? bookingTimeEl.value : null;
                    if (!d || !t) {
                        e.preventDefault();
                        alert('Please select a valid date and time.');
                        return;
                    }
                    if (bookingDateTimeHidden) bookingDateTimeHidden.value = `${d}T${t}`;
                });
            }
        });
    </script>

    <script>
        var map;
        var marker;

        function initMap() {
            var defaultCenter = { lat: mapConfig.lat, lng: mapConfig.lng };

            map = new google.maps.Map(document.getElementById("map"), {
                zoom: 13,
                center: defaultCenter,
                styles: [
                    {
                        featureType: "all",
                        elementType: "geometry",
                        stylers: [{ color: "#f5f5f5" }]
                    },
                    {
                        featureType: "water",
                        elementType: "geometry",
                        stylers: [{ color: "#c9e6f7" }]
                    },
                    {
                        featureType: "road",
                        elementType: "geometry",
                        stylers: [{ color: "#ffffff" }]
                    }
                ]
            });

            map.addListener("click", function(e) {
                var lat = e.latLng.lat();
                var lng = e.latLng.lng();

                if (!marker) {
                    marker = new google.maps.Marker({
                        position: { lat: lat, lng: lng },
                        map: map,
                        animation: google.maps.Animation.DROP,
                    });
                } else {
                    marker.setPosition({ lat: lat, lng: lng });
                }

                document.getElementById("Latitude").value = lat;
                document.getElementById("Longitude").value = lng;
                document.getElementById("latText").innerText = lat.toFixed(6);
                document.getElementById("lngText").innerText = lng.toFixed(6);
            });
        }
    </script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=@apiKey&callback=initMap"></script>
}