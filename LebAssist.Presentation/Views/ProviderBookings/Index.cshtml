@model IEnumerable<LebAssist.Application.DTOs.BookingDetailsDto>
@using Domain.Enums
@{
    ViewData["Title"] = "Booking Requests";
    var active = ViewBag.ActiveStatus as string ?? "All";
}

<div class="container mt-4">
    <h2>Booking Requests</h2>

    <div class="mb-3">
        <a class="btn btn-sm @(active=="All"?"btn-primary":"btn-outline-primary")" href="@Url.Action("Index", "ProviderBookings")">All</a>
        <a class="btn btn-sm @(active=="Pending"?"btn-primary":"btn-outline-primary")" href="@Url.Action("Index", "ProviderBookings", new { status = "Pending" })">Pending</a>
        <a class="btn btn-sm @(active=="Accepted"?"btn-primary":"btn-outline-primary")" href="@Url.Action("Index", "ProviderBookings", new { status = "Accepted" })">Accepted</a>
        <a class="btn btn-sm @(active=="InProgress"?"btn-primary":"btn-outline-primary")" href="@Url.Action("Index", "ProviderBookings", new { status = "InProgress" })">In Progress</a>
    </div>

    @if (!Model.Any())
    {
        <div class="alert alert-info">No booking requests.</div>
    }
    else
    {
        <div class="row g-3">
            @foreach (var b in Model)
            {
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-body d-flex align-items-center">
                            <div class="me-3">
                                @if (!string.IsNullOrEmpty(b.ClientPhotoPath))
                                {
                                    <img src="@b.ClientPhotoPath" class="rounded-circle" style="width:64px;height:64px;object-fit:cover;" />
                                }
                                else
                                {
                                    <div class="bg-secondary rounded-circle d-inline-flex align-items-center justify-content-center" style="width:64px;height:64px;">
                                        <i class="bi bi-person-fill text-white"></i>
                                    </div>
                                }
                            </div>

                            <div class="flex-grow-1">
                                <h5 class="mb-1">@b.ClientName</h5>
                                <p class="mb-1 small text-muted">@b.ClientPhone</p>
                                <p class="mb-1">Service: <strong>@b.ServiceName</strong></p>
                                <p class="mb-1">Location: 
                                    <a target="_blank" href="https://www.google.com/maps?q=@(b.Latitude.ToString(System.Globalization.CultureInfo.InvariantCulture)),@(b.Longitude.ToString(System.Globalization.CultureInfo.InvariantCulture))" class="btn btn-outline-primary btn-sm">
                                        View on map
                                    </a>
                                </p>
                                <p class="mb-0 small text-muted">Scheduled: @b.ScheduledDateTime.ToString("f")</p>
                            </div>

                            <div class="text-end">
                                @if (b.Status == BookingStatus.Pending)
                                {
                                    <form asp-action="Accept" method="post" class="mb-2">
                                        @Html.AntiForgeryToken()
                                        <input type="hidden" name="bookingId" value="@b.BookingId" />
                                        <button class="btn btn-success btn-sm">Accept</button>
                                    </form>
                                    <form asp-action="Reject" method="post">
                                        @Html.AntiForgeryToken()
                                        <input type="hidden" name="bookingId" value="@b.BookingId" />
                                        <button class="btn btn-danger btn-sm" onclick="return confirm('Reject this booking?');">Reject</button>
                                    </form>
                                }
                                else if (b.Status == BookingStatus.Accepted)
                                {
                                    <form asp-action="Start" method="post">
                                        @Html.AntiForgeryToken()
                                        <input type="hidden" name="bookingId" value="@b.BookingId" />
                                        <button class="btn btn-primary btn-sm">Start</button>
                                    </form>
                                }
                                else if (b.Status == BookingStatus.InProgress)
                                {
                                    <form asp-action="Complete" method="post">
                                        @Html.AntiForgeryToken()
                                        <input type="hidden" name="bookingId" value="@b.BookingId" />
                                        <button class="btn btn-success btn-sm">Complete</button>
                                    </form>
                                }
                                else
                                {
                                    <span class="badge bg-secondary">@b.Status</span>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>
