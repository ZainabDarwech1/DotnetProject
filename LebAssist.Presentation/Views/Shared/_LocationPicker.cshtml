@using Microsoft.Extensions.Options
@using LebAssist.Application.Common
@inject IOptions<GoogleMapsSettings> GoogleMapsSettings
@{
    var apiKey = GoogleMapsSettings.Value?.ApiKey ?? "";
    var mapId = ViewData["MapId"]?.ToString() ?? "location-map";
    var initialLat = ViewData["Latitude"] ?? 33.8938;
    var initialLng = ViewData["Longitude"] ?? 35.5018;
    var latFieldName = ViewData["LatFieldName"]?.ToString() ?? "Latitude";
    var lngFieldName = ViewData["LngFieldName"]?.ToString() ?? "Longitude";
    var height = ViewData["Height"]?.ToString() ?? "350px";
    var isReadOnly = ViewData["ReadOnly"] != null && ViewData["ReadOnly"] is bool readOnlyVal && readOnlyVal;
    var showCitySelector = ViewData["ShowCitySelector"] == null ? true : (ViewData["ShowCitySelector"] is bool b1 ? b1 : true);
    var showGpsButton = ViewData["ShowGPSButton"] == null ? true : (ViewData["ShowGPSButton"] is bool b2 ? b2 : true);
}

<div class="location-picker-container">
    <!-- Location Selection Methods -->
    @if (!isReadOnly)
    {
        <div class="row mb-2">
            @if (showCitySelector)
            {
                <div class="col-md-6">
                    <select id="@(mapId)-city-select" class="form-select" onchange="@(mapId)_selectCity()">
                        <option value="">-- Select City --</option>
                        <option value="33.8938,35.5018">Beirut</option>
                        <option value="34.4367,35.8497">Tripoli</option>
                        <option value="33.2705,35.2038">Sidon (Saida)</option>
                        <option value="33.2721,35.1964">Tyre (Sour)</option>
                        <option value="33.8547,35.8623">Zahle</option>
                        <option value="34.0047,36.2110">Baalbek</option>
                        <option value="33.5608,35.3733">Nabatieh</option>
                        <option value="33.8172,35.5361">Jounieh</option>
                        <option value="34.1236,35.6511">Byblos (Jbeil)</option>
                        <option value="33.9000,35.5500">Baabda</option>
                        <option value="33.8333,35.5000">Mount Lebanon</option>
                    </select>
                </div>
            }
            @if (showGpsButton)
            {
                <div class="col-md-6">
                    <button type="button" id="@(mapId)-gps-btn" class="btn btn-outline-primary w-100" onclick="@(mapId)_useGPS()">
                        <i class="bi bi-geo-alt-fill"></i> Use My GPS Location
                    </button>
                </div>
            }
        </div>
    }

    <!-- Hidden fields for latitude/longitude -->
    <input type="hidden" name="@latFieldName" id="@latFieldName" value="@initialLat" />
    <input type="hidden" name="@lngFieldName" id="@lngFieldName" value="@initialLng" />

    <div id="@mapId" style="height:@height; border:1px solid #e9ecef; border-radius:6px;"></div>
</div>

@section Scripts {
    <script src="https://maps.googleapis.com/maps/api/js?key=@apiKey"></script>
    <script>
        // Location picker functions scoped by mapId
        function @(mapId)_init() {
            const latField = document.getElementById('@latFieldName');
            const lngField = document.getElementById('@lngFieldName');
            const mapEl = document.getElementById('@mapId');

            const lat = parseFloat(latField.value) || 33.8938;
            const lng = parseFloat(lngField.value) || 35.5018;
            const center = { lat: lat, lng: lng };

            const map = new google.maps.Map(mapEl, {
                center: center,
                zoom: 12
            });

            let marker = new google.maps.Marker({ position: center, map: map, draggable: true });

            // Update hidden fields on marker drag end
            marker.addListener('dragend', function (e) {
                latField.value = e.latLng.lat();
                lngField.value = e.latLng.lng();
            });

            // Click to place marker
            map.addListener('click', function (e) {
                const pos = e.latLng;
                marker.setPosition(pos);
                latField.value = pos.lat();
                lngField.value = pos.lng();
            });

            // GPS helper
            window['@(mapId)_useGPS'] = function() {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(function (position) {
                        const p = { lat: position.coords.latitude, lng: position.coords.longitude };
                        map.setCenter(p);
                        marker.setPosition(p);
                        latField.value = p.lat;
                        lngField.value = p.lng;
                    }, function (err) {
                        alert('Failed to get GPS location: ' + err.message);
                    });
                } else {
                    alert('Geolocation not supported by your browser.');
                }
            };

            // City select helper
            window['@(mapId)_selectCity'] = function() {
                const sel = document.getElementById('@(mapId)-city-select');
                if (!sel) return;
                const val = sel.value;
                if (!val) return;
                const parts = val.split(',');
                const c = { lat: parseFloat(parts[0]), lng: parseFloat(parts[1]) };
                map.setCenter(c);
                marker.setPosition(c);
                latField.value = c.lat;
                lngField.value = c.lng;
            };
        }

        document.addEventListener('DOMContentLoaded', function() {
            if (typeof google === 'undefined') return;
            try { @(mapId)_init(); } catch(e) { console.error(e); }
        });
    </script>
}
