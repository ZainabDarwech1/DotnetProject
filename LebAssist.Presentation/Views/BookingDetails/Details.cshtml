@model Domain.Entities.Booking
@inject LebAssist.Application.Interfaces.IReviewService ReviewService
@{
    ViewData["Title"] = "Booking Details";
    var review = await ReviewService.GetReviewByBookingIdAsync(Model.BookingId);
    var hasReview = review != null;
}

<div class="booking-details-page">
    <!-- Header Section -->
    <div class="page-header">
        <div class="container">
            <!-- Breadcrumb -->
            <nav class="custom-breadcrumb" aria-label="breadcrumb">
                <ol class="breadcrumb-list">
                    <li class="breadcrumb-item">
                        <a href="@Url.Action("Index", "Home")">
                            <i class="bi bi-house-door"></i>
                            Home
                        </a>
                    </li>
                    <li class="breadcrumb-separator">
                        <i class="bi bi-chevron-right"></i>
                    </li>
                    <li class="breadcrumb-item">
                        <a href="@Url.Action("MyBookings", "Booking")">
                            My Bookings
                        </a>
                    </li>
                    <li class="breadcrumb-separator">
                        <i class="bi bi-chevron-right"></i>
                    </li>
                    <li class="breadcrumb-item active">
                        Booking #@Model.BookingId
                    </li>
                </ol>
            </nav>

            <!-- Page Title -->
            <div class="page-title-section">
                <h1 class="page-title">
                    <i class="bi bi-file-text"></i>
                    Booking Details
                </h1>
                <span class="status-badge-header status-@Model.Status.ToString().ToLower()">
                    @Html.Raw(GetStatusIcon(Model.Status))
                    @Model.Status
                </span>
            </div>
        </div>
    </div>

    <!-- Content Section -->
    <div class="container details-content">
        <div class="row">
            <!-- Main Content -->
            <div class="col-lg-8">
                <!-- Booking Information Card -->
                <div class="info-card">
                    <div class="card-header">
                        <i class="bi bi-info-circle"></i>
                        <h3>Booking Information</h3>
                    </div>
                    <div class="card-content">
                        <div class="info-grid">
                            <div class="info-item">
                                <label>Service</label>
                                <div class="info-value">@Model.Service?.ServiceName</div>
                            </div>
                            <div class="info-item">
                                <label>Category</label>
                                <div class="info-value">@Model.Service?.Category?.CategoryName</div>
                            </div>
                            <div class="info-item">
                                <label>Provider</label>
                                <div class="info-value">@Model.Provider?.FirstName @Model.Provider?.LastName</div>
                            </div>
                            <div class="info-item">
                                <label>Scheduled Date & Time</label>
                                <div class="info-value">
                                    <i class="bi bi-clock"></i>
                                    @Model.ScheduledDateTime.ToString("dddd, MMMM dd, yyyy 'at' hh:mm tt")
                                </div>
                            </div>
                        </div>

                        @if (!string.IsNullOrEmpty(Model.Notes))
                        {
                            <div class="notes-section">
                                <label>Notes</label>
                                <div class="notes-content">
                                    <i class="bi bi-chat-left-text"></i>
                                    <p>@Model.Notes</p>
                                </div>
                            </div>
                        }

                        @if (Model.Status == Domain.Enums.BookingStatus.Cancelled && !string.IsNullOrEmpty(Model.CancellationReason))
                        {
                            <div class="cancellation-alert">
                                <i class="bi bi-exclamation-triangle"></i>
                                <div>
                                    <label>Cancellation Reason</label>
                                    <p>@Model.CancellationReason</p>
                                </div>
                            </div>
                        }
                    </div>
                </div>

                <!-- Timeline Card -->
                <div class="info-card">
                    <div class="card-header">
                        <i class="bi bi-clock-history"></i>
                        <h3>Booking Timeline</h3>
                    </div>
                    <div class="card-content">
                        <div class="timeline">
                            <!-- Requested -->
                            <div class="timeline-item completed">
                                <div class="timeline-marker">
                                    <i class="bi bi-check-lg"></i>
                                </div>
                                <div class="timeline-content">
                                    <h4>Requested</h4>
                                    <span class="timeline-date">@Model.RequestDate.ToString("MMM dd, yyyy 'at' hh:mm tt")</span>
                                </div>
                            </div>

                            <!-- Accepted -->
                            <div class="timeline-item @(Model.Status >= Domain.Enums.BookingStatus.Accepted ? "completed" : Model.Status == Domain.Enums.BookingStatus.Rejected ? "rejected" : "")">
                                <div class="timeline-marker">
                                    @if (Model.Status >= Domain.Enums.BookingStatus.Accepted)
                                    {
                                        <i class="bi bi-check-lg"></i>
                                    }
                                    else if (Model.Status == Domain.Enums.BookingStatus.Rejected)
                                    {
                                        <i class="bi bi-x-lg"></i>
                                    }
                                </div>
                                <div class="timeline-content">
                                    <h4>@(Model.Status == Domain.Enums.BookingStatus.Rejected ? "Rejected" : "Accepted")</h4>
                                    @if (Model.Status >= Domain.Enums.BookingStatus.Accepted)
                                    {
                                        <span class="timeline-date">Provider accepted the booking</span>
                                    }
                                    else if (Model.Status == Domain.Enums.BookingStatus.Rejected)
                                    {
                                        <span class="timeline-date rejected">Booking was rejected by provider</span>
                                    }
                                    else
                                    {
                                        <span class="timeline-date">Waiting for provider response</span>
                                    }
                                </div>
                            </div>

                            <!-- In Progress -->
                            <div class="timeline-item @(Model.Status >= Domain.Enums.BookingStatus.InProgress ? "completed" : "")">
                                <div class="timeline-marker">
                                    @if (Model.Status >= Domain.Enums.BookingStatus.InProgress)
                                    {
                                        <i class="bi bi-check-lg"></i>
                                    }
                                </div>
                                <div class="timeline-content">
                                    <h4>In Progress</h4>
                                    @if (Model.Status >= Domain.Enums.BookingStatus.InProgress)
                                    {
                                        <span class="timeline-date">Service is currently in progress</span>
                                    }
                                    else
                                    {
                                        <span class="timeline-date">Service not started yet</span>
                                    }
                                </div>
                            </div>

                            <!-- Completed -->
                            <div class="timeline-item @(Model.Status == Domain.Enums.BookingStatus.Completed ? "completed" : "")">
                                <div class="timeline-marker">
                                    @if (Model.Status == Domain.Enums.BookingStatus.Completed)
                                    {
                                        <i class="bi bi-check-lg"></i>
                                    }
                                </div>
                                <div class="timeline-content">
                                    <h4>Completed</h4>
                                    @if (Model.Status == Domain.Enums.BookingStatus.Completed && Model.CompletedDate.HasValue)
                                    {
                                        <span class="timeline-date">@Model.CompletedDate.Value.ToString("MMM dd, yyyy 'at' hh:mm tt")</span>
                                    }
                                    else
                                    {
                                        <span class="timeline-date">Service not completed yet</span>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Review Section -->
                @if (User.IsInRole("Client") && Model.Status == Domain.Enums.BookingStatus.Completed)
                {
                    <div class="info-card review-card">
                        <div class="card-header">
                            <i class="bi bi-star-fill"></i>
                            <h3>Service Review</h3>
                        </div>
                        <div class="card-content">
                            @if (hasReview)
                            {
                                <div class="review-display">
                                    <div class="review-rating">
                                        @for (int i = 1; i <= 5; i++)
                                        {
                                            if (i <= review!.Rating)
                                            {
                                                <i class="bi bi-star-fill"></i>
                                            }
                                            else
                                            {
                                                <i class="bi bi-star"></i>
                                            }
                                        }
                                        <span class="rating-value">@review!.Rating/5</span>
                                        @if (review.IsAnonymous)
                                        {
                                            <span class="anonymous-badge">Anonymous</span>
                                        }
                                    </div>

                                    @if (!string.IsNullOrEmpty(review.Comment))
                                    {
                                        <div class="review-comment">
                                            <i class="bi bi-quote"></i>
                                            <p>@review.Comment</p>
                                        </div>
                                    }

                                    <div class="review-meta">
                                        <i class="bi bi-clock"></i>
                                        Reviewed on @review.ReviewDate.ToString("MMMM dd, yyyy")
                                    </div>

                                    @if (review.CanEdit)
                                    {
                                        <div class="review-actions">
                                            <a asp-controller="Review" asp-action="Edit" asp-route-id="@review.ReviewId"
                                               class="btn btn-edit">
                                                <i class="bi bi-pencil"></i>
                                                Edit Review
                                            </a>
                                            <div class="edit-notice">
                                                <i class="bi bi-info-circle"></i>
                                                You can edit this review until @review.ReviewDate.AddDays(7).ToString("MMMM dd, yyyy")
                                            </div>
                                        </div>
                                    }
                                </div>
                            }
                            else
                            {
                                <div class="review-prompt">
                                    <div class="prompt-icon">
                                        <i class="bi bi-star"></i>
                                    </div>
                                    <h4>How was your experience?</h4>
                                    <p>Share your feedback to help other clients and support the provider.</p>
                                    <a asp-controller="Review" asp-action="Create" asp-route-bookingId="@Model.BookingId"
                                       class="btn btn-primary">
                                        <i class="bi bi-star-fill"></i>
                                        Leave a Review
                                    </a>
                                </div>
                            }
                        </div>
                    </div>
                }
            </div>

            <!-- Sidebar -->
            <div class="col-lg-4">
                <!-- Provider Card -->
                <div class="info-card sidebar-card">
                    <div class="card-header">
                        <i class="bi bi-person-badge"></i>
                        <h3>Service Provider</h3>
                    </div>
                    <div class="card-content provider-card-content">
                        <div class="provider-avatar-large">
                            @if (!string.IsNullOrEmpty(Model.Provider?.ProfilePhotoPath))
                            {
                                <img src="@Model.Provider.ProfilePhotoPath" alt="@Model.Provider.FirstName">
                            }
                            else
                            {
                                <div class="avatar-placeholder">
                                    <i class="bi bi-person"></i>
                                </div>
                            }
                        </div>

                        <h4 class="provider-name">@Model.Provider?.FirstName @Model.Provider?.LastName</h4>

                        @if (Model.Provider?.ProviderAverageRating.HasValue == true)
                        {
                            <div class="provider-rating">
                                @for (int i = 1; i <= 5; i++)
                                {
                                    if (i <= Math.Round(Model.Provider.ProviderAverageRating.Value))
                                    {
                                        <i class="bi bi-star-fill"></i>
                                    }
                                    else
                                    {
                                        <i class="bi bi-star"></i>
                                    }
                                }
                                <span class="rating-value">@Model.Provider.ProviderAverageRating.Value.ToString("0.0")</span>
                                <span class="review-count">(@Model.Provider.TotalReviews reviews)</span>
                            </div>
                        }

                        <a asp-controller="Review" asp-action="ProviderReviews" asp-route-providerId="@Model.ProviderId"
                           class="btn btn-outline">
                            <i class="bi bi-star"></i>
                            View All Reviews
                        </a>
                    </div>
                </div>

                <!-- Provider Actions Card -->
                @if (User.IsInRole("Provider"))
                {
                    <div class="info-card sidebar-card">
                        <div class="card-header">
                            <i class="bi bi-lightning"></i>
                            <h3>Provider Actions</h3>
                        </div>
                        <div class="card-content">
                            @if (Model.Status == Domain.Enums.BookingStatus.Pending)
                            {
                                <form asp-action="Accept" method="post" class="action-form">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="bookingId" value="@Model.BookingId" />
                                    <button type="submit" class="btn btn-success">
                                        <i class="bi bi-check-lg"></i>
                                        Accept Booking
                                    </button>
                                </form>
                                <form asp-action="Reject" method="post" class="action-form">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="bookingId" value="@Model.BookingId" />
                                    <button type="submit" class="btn btn-danger"
                                            onclick="return confirm('Are you sure you want to reject this booking?');">
                                        <i class="bi bi-x-lg"></i>
                                        Reject Booking
                                    </button>
                                </form>
                            }
                            else if (Model.Status == Domain.Enums.BookingStatus.Accepted)
                            {
                                <form asp-action="Start" method="post" class="action-form">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="bookingId" value="@Model.BookingId" />
                                    <button type="submit" class="btn btn-primary">
                                        <i class="bi bi-play-fill"></i>
                                        Start Service
                                    </button>
                                </form>
                            }
                            else if (Model.Status == Domain.Enums.BookingStatus.InProgress)
                            {
                                <form asp-action="Complete" method="post" class="action-form">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="bookingId" value="@Model.BookingId" />
                                    <button type="submit" class="btn btn-success">
                                        <i class="bi bi-check-circle"></i>
                                        Mark as Complete
                                    </button>
                                </form>
                            }
                            else if (Model.Status == Domain.Enums.BookingStatus.Completed)
                            {
                                <div class="completion-status">
                                    <i class="bi bi-check-circle-fill"></i>
                                    <p>Service Completed</p>
                                </div>
                            }
                        </div>
                    </div>
                }

                <!-- Location Card -->
                <div class="info-card sidebar-card">
                    <div class="card-header">
                        <i class="bi bi-geo-alt"></i>
                        <h3>Service Location</h3>
                    </div>
                    <div class="card-content">
                        <div id="map" class="location-map"></div>
                        <div class="coordinates">
                            <i class="bi bi-geo-alt-fill"></i>
                            <span>@Model.Latitude, @Model.Longitude</span>
                        </div>
                        <a href="https://www.google.com/maps?q=@Model.Latitude,@Model.Longitude"
                           target="_blank" class="btn btn-outline">
                            <i class="bi bi-box-arrow-up-right"></i>
                            Open in Google Maps
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@functions {
    string GetStatusIcon(Domain.Enums.BookingStatus status)
    {
        return status switch
        {
            Domain.Enums.BookingStatus.Pending => "<i class='bi bi-clock-history'></i>",
            Domain.Enums.BookingStatus.Accepted => "<i class='bi bi-check-circle'></i>",
            Domain.Enums.BookingStatus.Rejected => "<i class='bi bi-x-circle'></i>",
            Domain.Enums.BookingStatus.InProgress => "<i class='bi bi-hourglass-split'></i>",
            Domain.Enums.BookingStatus.Completed => "<i class='bi bi-check-circle-fill'></i>",
            Domain.Enums.BookingStatus.Cancelled => "<i class='bi bi-x-circle-fill'></i>",
            _ => "<i class='bi bi-circle'></i>"
        };
    }
}

@section Styles {
    <link rel="stylesheet" href="~/css/booking-details.css" asp-append-version="true" />
}

@section Scripts {
    <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const lat = @Model.Latitude;
            const lng = @Model.Longitude;

            const map = new google.maps.Map(document.getElementById('map'), {
                center: { lat: parseFloat(lat), lng: parseFloat(lng) },
                zoom: 15,
                disableDefaultUI: true,
                zoomControl: true,
                styles: [
                    {
                        featureType: "all",
                        elementType: "geometry",
                        stylers: [{ color: "#f5f5f5" }]
                    },
                    {
                        featureType: "water",
                        elementType: "geometry",
                        stylers: [{ color: "#c9e6f7" }]
                    },
                    {
                        featureType: "road",
                        elementType: "geometry",
                        stylers: [{ color: "#ffffff" }]
                    }
                ]
            });

            new google.maps.Marker({
                position: { lat: parseFloat(lat), lng: parseFloat(lng) },
                map: map,
                title: 'Service Location'
            });
        });
    </script>
}