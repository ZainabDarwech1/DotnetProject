@using Microsoft.Extensions.Options
@using LebAssist.Application.Common
@inject IOptions<GoogleMapsSettings> GoogleMapsSettings
@model LebAssist.Presentation.ViewModels.Emergency.EmergencyDetailsViewModel
@{
    ViewData["Title"] = "Emergency Details";
    var apiKey = GoogleMapsSettings.Value.ApiKey;
}

<div class="emergency-details-page">
    <!-- Header Section -->
    <div class="page-header">
        <div class="container">
            <!-- Breadcrumb -->
            <nav class="custom-breadcrumb" aria-label="breadcrumb">
                <ol class="breadcrumb-list">
                    <li class="breadcrumb-item">
                        <a href="@Url.Action("Index", "Home")">
                            <i class="bi bi-house-door"></i>
                            Home
                        </a>
                    </li>
                    <li class="breadcrumb-separator">
                        <i class="bi bi-chevron-right"></i>
                    </li>
                    <li class="breadcrumb-item">
                        <a href="@Url.Action("Index", "Emergency")">
                            <i class="bi bi-exclamation-triangle-fill"></i>
                            Emergency Requests
                        </a>
                    </li>
                    <li class="breadcrumb-separator">
                        <i class="bi bi-chevron-right"></i>
                    </li>
                    <li class="breadcrumb-item active">
                        Request #@Model.EmergencyRequestId
                    </li>
                </ol>
            </nav>

            <!-- Page Title -->
            <div class="page-title-section">
                <h1 class="page-title">
                    <i class="bi bi-exclamation-triangle-fill"></i>
                    Emergency Request #@Model.EmergencyRequestId
                </h1>
                <p class="page-subtitle">View details and track progress</p>
            </div>

            <!-- Status Badge -->
            <div class="header-status">
                <span class="status-badge status-@Model.Status.ToString().ToLower()">
                    @if (Model.Status == "Pending")
                    {
                        <i class="bi bi-clock-history"></i>
                    }
                    else if (Model.Status == "Accepted")
                    {
                        <i class="bi bi-check-circle"></i>
                    }
                    else if (Model.Status == "InProgress")
                    {
                        <i class="bi bi-hourglass-split"></i>
                    }
                    else if (Model.Status == "Completed")
                    {
                        <i class="bi bi-check-all"></i>
                    }
                    @Model.Status
                </span>
            </div>
        </div>
    </div>

    <!-- Content Section -->
    <div class="container details-content">
        <div class="details-wrapper">
            <!-- Service Info Card -->
            <div class="info-card">
                <div class="card-header">
                    <i class="bi bi-tools"></i>
                    <h3>Service Information</h3>
                </div>
                <div class="card-content">
                    <div class="service-display">
                        <i class="bi bi-gear-fill"></i>
                        <span class="service-name">@Model.ServiceName</span>
                    </div>
                </div>
            </div>

            <!-- Description Card -->
            <div class="info-card">
                <div class="card-header">
                    <i class="bi bi-card-text"></i>
                    <h3>Emergency Details</h3>
                </div>
                <div class="card-content">
                    <div class="details-text">
                        <p>@Model.Details</p>
                    </div>
                </div>
            </div>

            <!-- People Info Cards -->
            <div class="people-grid">
                <!-- Client Info -->
                <div class="info-card">
                    <div class="card-header">
                        <i class="bi bi-person-fill"></i>
                        <h3>Client Information</h3>
                    </div>
                    <div class="card-content">
                        <div class="person-info">
                            <div class="person-name">@Model.ClientName</div>
                            @if (!string.IsNullOrEmpty(Model.ClientPhone))
                            {
                                <a href="tel:@Model.ClientPhone" class="person-contact">
                                    <i class="bi bi-telephone-fill"></i>
                                    @Model.ClientPhone
                                </a>
                            }
                        </div>
                    </div>
                </div>

                <!-- Provider Info -->
                @if (!string.IsNullOrEmpty(Model.ProviderName))
                {
                    <div class="info-card provider-card">
                        <div class="card-header">
                            <i class="bi bi-person-badge-fill"></i>
                            <h3>Assigned Provider</h3>
                        </div>
                        <div class="card-content">
                            <div class="person-info">
                                <div class="person-name provider-name">
                                    <i class="bi bi-patch-check-fill"></i>
                                    @Model.ProviderName
                                </div>
                                @if (!string.IsNullOrEmpty(Model.ProviderPhone))
                                {
                                    <a href="tel:@Model.ProviderPhone" class="person-contact provider-contact">
                                        <i class="bi bi-telephone-fill"></i>
                                        @Model.ProviderPhone
                                    </a>
                                }
                            </div>
                        </div>
                    </div>
                }
            </div>

            <!-- Location Card -->
            <div class="info-card">
                <div class="card-header">
                    <i class="bi bi-geo-alt-fill"></i>
                    <h3>Location</h3>
                </div>
                <div class="card-content">
                    <div class="map-wrapper">
                        <div id="map" class="map-container"></div>
                    </div>
                    <div class="location-details">
                        <div class="coordinates">
                            <span class="coord-badge">
                                <i class="bi bi-geo"></i>
                                Lat: @Model.Latitude.ToString("F6")
                            </span>
                            <span class="coord-badge">
                                <i class="bi bi-geo"></i>
                                Lng: @Model.Longitude.ToString("F6")
                            </span>
                        </div>
                        <a href="https://www.google.com/maps/dir/?api=1&destination=@Model.Latitude,@Model.Longitude"
                           target="_blank"
                           class="directions-btn">
                            <i class="bi bi-pin-map"></i>
                            Get Directions
                        </a>
                    </div>
                </div>
            </div>

            <!-- Timeline Card -->
            <div class="info-card">
                <div class="card-header">
                    <i class="bi bi-clock-history"></i>
                    <h3>Timeline</h3>
                </div>
                <div class="card-content">
                    <div class="timeline">
                        <div class="timeline-item">
                            <div class="timeline-marker marker-warning">
                                <i class="bi bi-circle-fill"></i>
                            </div>
                            <div class="timeline-content">
                                <div class="timeline-title">Request Created</div>
                                <div class="timeline-date">@Model.RequestDateTime.ToString("MMMM dd, yyyy 'at' hh:mm tt")</div>
                            </div>
                        </div>

                        @if (Model.AcceptedDateTime.HasValue)
                        {
                            <div class="timeline-item">
                                <div class="timeline-marker marker-primary">
                                    <i class="bi bi-circle-fill"></i>
                                </div>
                                <div class="timeline-content">
                                    <div class="timeline-title">Provider Accepted</div>
                                    <div class="timeline-date">@Model.AcceptedDateTime.Value.ToString("MMMM dd, yyyy 'at' hh:mm tt")</div>
                                </div>
                            </div>
                        }

                        @if (Model.CompletedDate.HasValue)
                        {
                            <div class="timeline-item">
                                <div class="timeline-marker marker-success">
                                    <i class="bi bi-circle-fill"></i>
                                </div>
                                <div class="timeline-content">
                                    <div class="timeline-title">Service Completed</div>
                                    <div class="timeline-date">@Model.CompletedDate.Value.ToString("MMMM dd, yyyy 'at' hh:mm tt")</div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <!-- Provider Actions -->
            @if (Model.IsAssignedProvider)
            {
                <div class="actions-card">
                    @if (Model.Status == "Accepted")
                    {
                        <form asp-action="Start" method="post" class="action-form">
                            <input type="hidden" name="emergencyId" value="@Model.EmergencyRequestId" />
                            <button type="submit" class="btn btn-start">
                                <i class="bi bi-play-circle"></i>
                                Start Working
                            </button>
                        </form>
                    }
                    @if (Model.Status == "InProgress")
                    {
                        <form asp-action="Complete" method="post" class="action-form">
                            <input type="hidden" name="emergencyId" value="@Model.EmergencyRequestId" />
                            <button type="submit" class="btn btn-complete">
                                <i class="bi bi-check-circle"></i>
                                Mark as Complete
                            </button>
                        </form>
                    }
                </div>
            }

            <!-- Back Button -->
            <div class="back-action">
                <a asp-action="Index" class="btn btn-back">
                    <i class="bi bi-arrow-left"></i>
                    Back to Requests
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Pass values to JavaScript -->
<script>
    var mapConfig = {
        lat: @Model.Latitude.ToString(System.Globalization.CultureInfo.InvariantCulture),
        lng: @Model.Longitude.ToString(System.Globalization.CultureInfo.InvariantCulture)
    };
</script>

@section Styles {
    <link rel="stylesheet" href="~/css/emergencyDetails.css" />
}

@section Scripts {
    <script>
        function initMap() {
            var pos = { lat: mapConfig.lat, lng: mapConfig.lng };
            var map = new google.maps.Map(document.getElementById("map"), {
                zoom: 15,
                center: pos,
                styles: [
                    {
                        featureType: "poi",
                        elementType: "labels",
                        stylers: [{ visibility: "off" }]
                    }
                ]
            });

            new google.maps.Marker({
                position: pos,
                map: map,
                animation: google.maps.Animation.DROP,
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 10,
                    fillColor: "#ef4444",
                    fillOpacity: 1,
                    strokeColor: "#ffffff",
                    strokeWeight: 2
                }
            });
        }

        // Animate cards on load
        document.addEventListener('DOMContentLoaded', function() {
            const cards = document.querySelectorAll('.info-card, .actions-card');
            cards.forEach((card, index) => {
                card.style.opacity = '0';
                card.style.transform = 'translateY(20px)';
                setTimeout(() => {
                    card.style.transition = 'all 0.5s ease';
                    card.style.opacity = '1';
                    card.style.transform = 'translateY(0)';
                }, index * 100);
            });
        });
    </script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=@apiKey&callback=initMap"></script>
}
