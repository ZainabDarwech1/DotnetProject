@model LebAssist.Presentation.ViewModels.Review.ProviderReviewsViewModel
@{
    ViewData["Title"] = $"Reviews for {Model.ProviderName}";
}

<div class="review-page">

    <!-- Header -->
    <div class="page-header">
        <div class="container">

            <!-- Breadcrumb -->
            <nav class="custom-breadcrumb">
                <ol class="breadcrumb-list">
                    <li class="breadcrumb-item">
                        <a asp-controller="Home" asp-action="Index">
                            <i class="bi bi-house-door"></i> Home
                        </a>
                    </li>
                    <li class="breadcrumb-separator">
                        <i class="bi bi-chevron-right"></i>
                    </li>
                    <li class="breadcrumb-item">
                        <a asp-controller="Services" asp-action="Index">
                            Providers
                        </a>
                    </li>
                    <li class="breadcrumb-separator">
                        <i class="bi bi-chevron-right"></i>
                    </li>
                    <li class="breadcrumb-item active">
                        Reviews
                    </li>
                </ol>
            </nav>

            <div class="page-title-section">
                <h1 class="page-title">
                    <i class="bi bi-chat-square-text"></i>
                    Reviews
                </h1>
                <p class="page-subtitle">
                    What clients say about @Model.ProviderName
                </p>
            </div>
        </div>
    </div>

    <!-- Content -->
    <div class="container reviews-content">
        <div class="reviews-wrapper">

            <div class="row g-4">

                <!-- LEFT: SUMMARY -->
                <div class="col-lg-4">

                    <div class="booking-info-card sticky-top" style="top: 1rem;">
                        <div class="info-header">
                            <i class="bi bi-person-badge"></i>
                            <h3>Provider Summary</h3>
                        </div>

                        <div class="info-content text-center">

                            <!-- Provider Photo -->
                            @if (!string.IsNullOrEmpty(Model.ProviderPhotoPath))
                            {
                                <img src="@Model.ProviderPhotoPath"
                                     class="rounded-circle mb-3"
                                     style="width:100px;height:100px;object-fit:cover;" />
                            }
                            else
                            {
                                <div class="rounded-circle d-flex align-items-center justify-content-center mb-3"
                                     style="width:100px;height:100px;background:#dee2e6;">
                                    <i class="bi bi-person-fill fs-1 text-muted"></i>
                                </div>
                            }

                            <h4 class="mb-2">@Model.ProviderName</h4>

                            <!-- Average Rating -->
                            <div class="my-3">
                                <div class="display-4 fw-bold text-warning">
                                    @Model.AverageRating.ToString("0.0")
                                </div>

                                <div class="mb-2">
                                    @for (int i = 1; i <= 5; i++)
                                    {
                                        if (i <= Math.Round(Model.AverageRating))
                                        {
                                            <i class="bi bi-star-fill text-warning"></i>
                                        }
                                        else
                                        {
                                            <i class="bi bi-star text-muted"></i>
                                        }
                                    }
                                </div>

                                <p class="text-muted">
                                    Based on @Model.TotalReviews review@(Model.TotalReviews != 1 ? "s" : "")
                                </p>
                            </div>

                            <!-- Rating Distribution -->
                            <div class="text-start mt-4">
                                @for (int i = 5; i >= 1; i--)
                                {
                                    var count = Model.RatingDistribution.GetValueOrDefault(i, 0);
                                    var percentage = Model.RatingPercentages.GetValueOrDefault(i, 0);

                                    <div class="d-flex align-items-center mb-2">
                                        <span style="width:20px">@i</span>
                                        <i class="bi bi-star-fill text-warning mx-2"></i>

                                        <div class="flex-grow-1" style="height:8px;background:#e9ecef;border-radius:4px;">
                                            <div style="width:@percentage%;height:100%;background:#f59e0b;border-radius:4px;"></div>
                                        </div>

                                        <span class="ms-2 text-muted" style="width:30px">@count</span>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                </div>

                <!-- RIGHT: REVIEWS -->
                <div class="col-lg-8">

                    <!-- Header + Sort -->
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h3 class="mb-0">All Reviews</h3>

                        <div class="dropdown">
                            <button class="btn btn-cancel dropdown-toggle"
                                    data-bs-toggle="dropdown">
                                Sort:
                                @(Model.SortBy == "highest" ? "Highest Rated"
                                                                : Model.SortBy == "lowest" ? "Lowest Rated"
                                                                : "Most Recent")
                            </button>

                            <ul class="dropdown-menu">
                                <li>
                                    <a class="dropdown-item"
                                       asp-route-sortBy="newest"
                                       asp-route-providerId="@Model.ProviderId">
                                        Most Recent
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item"
                                       asp-route-sortBy="highest"
                                       asp-route-providerId="@Model.ProviderId">
                                        Highest Rated
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item"
                                       asp-route-sortBy="lowest"
                                       asp-route-providerId="@Model.ProviderId">
                                        Lowest Rated
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </div>

                    <!-- Empty State -->
                    @if (!Model.Reviews.Any())
                    {
                        <div class="text-center py-5">
                            <i class="bi bi-chat-square-text display-1 text-muted"></i>
                            <h5 class="mt-3 text-muted">No Reviews Yet</h5>
                            <p class="text-muted">
                                This provider hasn’t received any reviews yet.
                            </p>
                        </div>
                    }
                    else
                    {
                        <!-- Reviews -->
                        @foreach (var review in Model.Reviews)
                        {
                            <div class="review-form-card mb-3">

                                <div class="d-flex">

                                    <!-- Avatar -->
                                    @if (!review.IsAnonymous && !string.IsNullOrEmpty(review.ClientPhotoPath))
                                    {
                                        <img src="@review.ClientPhotoPath"
                                             class="rounded-circle me-3"
                                             style="width:48px;height:48px;object-fit:cover;" />
                                    }
                                    else
                                    {
                                        <div class="rounded-circle d-flex align-items-center justify-content-center me-3"
                                             style="width:48px;height:48px;background:#dee2e6;">
                                            <i class="bi bi-person-fill text-muted"></i>
                                        </div>
                                    }

                                    <!-- Content -->
                                    <div class="flex-grow-1">

                                        <div class="d-flex justify-content-between">
                                            <div>
                                                <strong>@review.ClientName</strong>
                                                <div class="text-muted small">
                                                    @review.ServiceName • @review.TimeAgo
                                                </div>
                                            </div>

                                            <div>
                                                @for (int i = 1; i <= 5; i++)
                                                {
                                                    if (i <= review.Rating)
                                                    {
                                                        <i class="bi bi-star-fill text-warning"></i>
                                                    }
                                                    else
                                                    {
                                                        <i class="bi bi-star text-muted"></i>
                                                    }
                                                }
                                            </div>
                                        </div>

                                        @if (!string.IsNullOrWhiteSpace(review.Comment))
                                        {
                                            <p class="mt-2 mb-0">
                                                @review.Comment
                                            </p>
                                        }
                                    </div>
                                </div>
                            </div>
                        }

                        <!-- Pagination -->
                        @if (Model.TotalPages > 1)
                        {
                            <nav class="mt-4">
                                <ul class="pagination justify-content-center">

                                    <li class="page-item @(Model.CurrentPage == 1 ? "disabled" : "")">
                                        <a class="page-link"
                                           asp-route-page="@(Model.CurrentPage - 1)"
                                           asp-route-providerId="@Model.ProviderId"
                                           asp-route-sortBy="@Model.SortBy">
                                            <i class="bi bi-chevron-left"></i>
                                        </a>
                                    </li>

                                    @for (int i = 1; i <= Model.TotalPages; i++)
                                    {
                                        <li class="page-item @(i == Model.CurrentPage ? "active" : "")">
                                            <a class="page-link"
                                               asp-route-page="@i"
                                               asp-route-providerId="@Model.ProviderId"
                                               asp-route-sortBy="@Model.SortBy">
                                                @i
                                            </a>
                                        </li>
                                    }

                                    <li class="page-item @(Model.CurrentPage == Model.TotalPages ? "disabled" : "")">
                                        <a class="page-link"
                                           asp-route-page="@(Model.CurrentPage + 1)"
                                           asp-route-providerId="@Model.ProviderId"
                                           asp-route-sortBy="@Model.SortBy">
                                            <i class="bi bi-chevron-right"></i>
                                        </a>
                                    </li>

                                </ul>
                            </nav>
                        }
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@section Styles {
    <link rel="stylesheet" href="~/css/reviewCreate.css" />
}
