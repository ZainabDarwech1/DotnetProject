@model LebAssist.Presentation.ViewModels.Provider.PortfolioViewModel
@{
    ViewData["Title"] = "My Portfolio";
}

<div class="portfolio-page">
    <!-- Header Section -->
    <div class="page-header">
        <div class="container">
            <!-- Breadcrumb -->
            <nav class="custom-breadcrumb" aria-label="breadcrumb">
                <ol class="breadcrumb-list">
                    <li class="breadcrumb-item">
                        <a href="@Url.Action("Index", "Home")">
                            <i class="bi bi-house-door"></i>
                            Home
                        </a>
                    </li>
                    <li class="breadcrumb-separator">
                        <i class="bi bi-chevron-right"></i>
                    </li>
                    <li class="breadcrumb-item">
                        <a href="@Url.Action("Dashboard", "Provider")">
                            <i class="bi bi-speedometer2"></i>
                            Provider Dashboard
                        </a>
                    </li>
                    <li class="breadcrumb-separator">
                        <i class="bi bi-chevron-right"></i>
                    </li>
                    <li class="breadcrumb-item active">
                        My Portfolio
                    </li>
                </ol>
            </nav>

            <!-- Page Title -->
            <div class="page-title-section">
                <h1 class="page-title">
                    <i class="bi bi-images"></i>
                    My Portfolio
                </h1>
                <p class="page-subtitle">Showcase your best work to attract more clients</p>
            </div>

            <!-- Stats and Action -->
            <div class="header-actions">
                @if (Model.Photos != null && Model.Photos.Any())
                {
                    <div class="stats-badge">
                        <div class="stat-item">
                            <i class="bi bi-image"></i>
                            <span class="stat-value">@Model.Photos.Count()</span>
                            <span class="stat-label">@(Model.Photos.Count() == 1 ? "Photo" : "Photos")</span>
                        </div>
                    </div>
                }
                <button type="button" class="btn btn-upload" data-bs-toggle="modal" data-bs-target="#uploadModal">
                    <i class="bi bi-upload"></i>
                    Upload Photo
                </button>
            </div>
        </div>
    </div>

    <!-- Content Section -->
    <div class="container portfolio-content">
        @if (Model.Photos != null && Model.Photos.Any())
        {
            <!-- Portfolio Grid -->
            <div class="portfolio-grid" id="portfolio-grid">
                @foreach (var photo in Model.Photos)
                {
                    <div class="portfolio-item" data-photo-id="@photo.PortfolioPhotoId">
                        <div class="photo-card">
                            <div class="photo-wrapper">
                                <img src="@photo.PhotoPath" alt="Portfolio" class="photo-img" loading="lazy">
                                <div class="photo-overlay">
                                    <button class="btn-view" onclick="viewImage('@photo.PhotoPath')">
                                        <i class="bi bi-zoom-in"></i>
                                    </button>
                                    <button class="btn-delete delete-photo" data-photo-id="@photo.PortfolioPhotoId">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="photo-info">
                                @if (!string.IsNullOrEmpty(photo.Caption))
                                {
                                    <p class="photo-caption">@photo.Caption</p>
                                }
                                else
                                {
                                    <p class="photo-caption no-caption">No caption</p>
                                }
                                <div class="photo-date">
                                    <i class="bi bi-calendar"></i>
                                    @photo.UploadDate.ToString("MMM dd, yyyy")
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        }
        else
        {
            <!-- Empty State -->
            <div class="empty-state">
                <div class="empty-icon">
                    <i class="bi bi-images"></i>
                </div>
                <h3 class="empty-title">No Portfolio Photos Yet</h3>
                <p class="empty-description">
                    Start building your portfolio by uploading photos of your best work. A strong portfolio helps attract more clients!
                </p>
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#uploadModal">
                    <i class="bi bi-upload"></i>
                    Upload Your First Photo
                </button>
            </div>
        }
    </div>
</div>

<!-- Upload Modal -->
<div class="modal fade" id="uploadModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form asp-action="AddPortfolioPhoto" method="post" enctype="multipart/form-data" id="uploadForm">
                <div class="modal-header">
                    <div class="modal-title-section">
                        <h5 class="modal-title">
                            <i class="bi bi-upload"></i>
                            Upload Portfolio Photo
                        </h5>
                        <p class="modal-subtitle">Add a new photo to your portfolio</p>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Image Preview -->
                    <div class="image-preview-container" id="imagePreviewContainer" style="display: none;">
                        <img id="imagePreview" src="" alt="Preview" class="image-preview">
                        <button type="button" class="btn-remove-preview" onclick="removePreview()">
                            <i class="bi bi-x-circle"></i>
                        </button>
                    </div>

                    <!-- File Upload -->
                    <div class="form-group">
                        <label for="Photo" class="form-label">
                            <i class="bi bi-image"></i>
                            Select Photo
                            <span class="required">*</span>
                        </label>
                        <div class="file-input-wrapper">
                            <input type="file"
                                   class="file-input"
                                   id="Photo"
                                   name="Photo"
                                   accept="image/jpeg,image/jpg,image/png,image/webp"
                                   required
                                   onchange="previewImage(this)" />
                            <label for="Photo" class="file-input-label">
                                <i class="bi bi-cloud-upload"></i>
                                <span class="file-text">Choose a photo or drag it here</span>
                                <span class="file-hint">JPG, PNG, WEBP • Max 5MB</span>
                            </label>
                        </div>
                    </div>

                    <!-- Caption Input -->
                    <div class="form-group">
                        <label for="Caption" class="form-label">
                            <i class="bi bi-chat-text"></i>
                            Caption
                            <span class="optional">(Optional)</span>
                        </label>
                        <input type="text"
                               class="form-control"
                               id="Caption"
                               name="Caption"
                               maxlength="200"
                               placeholder="Describe this photo..." />
                        <div class="char-counter">
                            <span id="charCount">0</span>/200 characters
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle"></i>
                        Cancel
                    </button>
                    <button type="submit" class="btn btn-primary" id="uploadBtn">
                        <i class="bi bi-upload"></i>
                        Upload Photo
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Image Viewer Modal -->
<div class="image-viewer-modal" id="imageViewer" onclick="closeViewer()">
    <div class="viewer-content">
        <button class="viewer-close" onclick="closeViewer()">
            <i class="bi bi-x-lg"></i>
        </button>
        <img id="viewerImage" src="" alt="Portfolio Photo">
    </div>
</div>

@section Styles {
    <link rel="stylesheet" href="~/css/portfolio.css" />
}

@section Scripts {
    @Html.AntiForgeryToken()
    <script>
        // Image preview
        function previewImage(input) {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('imagePreview').src = e.target.result;
                    document.getElementById('imagePreviewContainer').style.display = 'block';
                    document.querySelector('.file-input-label').style.display = 'none';
                };
                reader.readAsDataURL(file);
            }
        }

        function removePreview() {
            document.getElementById('Photo').value = '';
            document.getElementById('imagePreviewContainer').style.display = 'none';
            document.querySelector('.file-input-label').style.display = 'flex';
        }

        // Character counter
        const captionInput = document.getElementById('Caption');
        const charCount = document.getElementById('charCount');
        if (captionInput) {
            captionInput.addEventListener('input', function() {
                charCount.textContent = this.value.length;
            });
        }

        // View image in fullscreen
        function viewImage(imagePath) {
            document.getElementById('viewerImage').src = imagePath;
            document.getElementById('imageViewer').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeViewer() {
            document.getElementById('imageViewer').classList.remove('active');
            document.body.style.overflow = 'auto';
        }

        // Delete photo
        document.querySelectorAll('.delete-photo').forEach(btn => {
            btn.addEventListener('click', async function(e) {
                e.stopPropagation();

                if (!confirm('Are you sure you want to delete this photo? This action cannot be undone.')) return;

                const photoId = this.dataset.photoId;
                const photoItem = document.querySelector(`[data-photo-id="${photoId}"]`);

                this.innerHTML = '<i class="bi bi-hourglass-split"></i>';
                this.disabled = true;

                const formData = new FormData();
                formData.append('photoId', photoId);
                formData.append('__RequestVerificationToken', document.querySelector('input[name="__RequestVerificationToken"]').value);

                try {
                    const response = await fetch('@Url.Action("DeletePortfolioPhoto")', {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();
                    if (result.success) {
                        // Fade out animation
                        photoItem.style.opacity = '0';
                        photoItem.style.transform = 'scale(0.8)';
                        setTimeout(() => {
                            photoItem.remove();

                            // Check if no photos left
                            const remainingPhotos = document.querySelectorAll('.portfolio-item');
                            if (remainingPhotos.length === 0) {
                                location.reload();
                            }
                        }, 300);
                    } else {
                        alert('Failed to delete photo. Please try again.');
                        this.innerHTML = '<i class="bi bi-trash"></i>';
                        this.disabled = false;
                    }
                } catch (error) {
                    alert('An error occurred. Please try again.');
                    this.innerHTML = '<i class="bi bi-trash"></i>';
                    this.disabled = false;
                }
            });
        });

        // Form submission
        document.getElementById('uploadForm').addEventListener('submit', function() {
            const uploadBtn = document.getElementById('uploadBtn');
            uploadBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Uploading...';
            uploadBtn.disabled = true;
        });

        // Animate portfolio items on load
        document.addEventListener('DOMContentLoaded', function() {
            const portfolioItems = document.querySelectorAll('.portfolio-item');
            portfolioItems.forEach((item, index) => {
                item.style.opacity = '0';
                item.style.transform = 'translateY(20px)';
                setTimeout(() => {
                    item.style.transition = 'all 0.5s ease';
                    item.style.opacity = '1';
                    item.style.transform = 'translateY(0)';
                }, index * 100);
            });

            // Modal reset on close
            const uploadModal = document.getElementById('uploadModal');
            uploadModal.addEventListener('hidden.bs.modal', function() {
                removePreview();
                document.getElementById('Caption').value = '';
                document.getElementById('charCount').textContent = '0';
            });
        });

        // Escape key to close viewer
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeViewer();
            }
        });
    </script>
}
