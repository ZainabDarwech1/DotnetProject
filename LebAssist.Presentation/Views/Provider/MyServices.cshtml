@model IEnumerable<LebAssist.Presentation.ViewModels.Provider.ProviderServiceViewModel>
@{
    ViewData["Title"] = "My Services";
    var counter = 1;
}

<div class="services-management-page">
    <!-- Header Section -->
    <div class="page-header">
        <div class="container">
            <!-- Breadcrumb -->
            <nav class="custom-breadcrumb" aria-label="breadcrumb">
                <ol class="breadcrumb-list">
                    <li class="breadcrumb-item">
                        <a href="@Url.Action("Index", "Home")">
                            <i class="bi bi-house-door"></i>
                            Home
                        </a>
                    </li>
                    <li class="breadcrumb-separator">
                        <i class="bi bi-chevron-right"></i>
                    </li>
                    <li class="breadcrumb-item">
                        <a href="@Url.Action("Dashboard", "Provider")">
                            <i class="bi bi-speedometer2"></i>
                            Provider Dashboard
                        </a>
                    </li>
                    <li class="breadcrumb-separator">
                        <i class="bi bi-chevron-right"></i>
                    </li>
                    <li class="breadcrumb-item active">
                        My Services
                    </li>
                </ol>
            </nav>

            <!-- Page Title -->
            <div class="page-title-section">
                <h1 class="page-title">
                    <i class="bi bi-gear-fill"></i>
                    My Services
                </h1>
                <p class="page-subtitle">Manage your service offerings and pricing</p>
            </div>

            <!-- Stats and Action -->
            <div class="header-actions">
                @if (Model != null && Model.Any())
                {
                    <div class="stats-badge">
                        <div class="stat-item">
                            <i class="bi bi-tools"></i>
                            <span class="stat-value">@Model.Count()</span>
                            <span class="stat-label">@(Model.Count() == 1 ? "Service" : "Services")</span>
                        </div>
                        <div class="stat-item">
                            <i class="bi bi-check-circle"></i>
                            <span class="stat-value">@Model.Count(s => s.IsActive)</span>
                            <span class="stat-label">Active</span>
                        </div>
                    </div>
                }
                <a href="@Url.Action("AddService")" class="btn btn-add-service">
                    <i class="bi bi-plus-circle"></i>
                    Add New Service
                </a>
            </div>
        </div>
    </div>

    <!-- Content Section -->
    <div class="container services-content">
        @if (Model != null && Model.Any())
        {
            <!-- Services Table Card -->
            <div class="table-card">
                <div class="table-card-header">
                    <div class="table-info">
                        <i class="bi bi-list-ul"></i>
                        <h3>Service List</h3>
                    </div>
                </div>
                <div class="table-card-body">
                    <div class="table-responsive">
                        <table id="servicesTable" class="services-table">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Service Name</th>
                                    <th>Category</th>
                                    <th>Price/Hour</th>
                                    <th>Status</th>
                                    <th>Date Added</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var service in Model)
                                {
                                    <tr>
                                        <td>
                                            @counter
                                        </td>
                                        <td>
                                            <div class="service-name-cell">
                                                <i class="bi bi-tools"></i>
                                                <span>@service.ServiceName</span>
                                            </div>
                                        </td>
                                        <td>
                                            <span class="category-badge">
                                                <i class="bi bi-tag"></i>
                                                @service.CategoryName
                                            </span>
                                        </td>
                                        <td>
                                            <div class="price-input-wrapper">
                                                <span class="currency-symbol">$</span>
                                                <input type="number"
                                                       class="price-input"
                                                       value="@(service.PricePerHour.ToString("F2") ?? "")"
                                                       data-service-id="@service.ServiceId"
                                                       placeholder="Set price"
                                                       step="0.01"
                                                       min="0">
                                            </div>
                                        </td>
                                        <td>
                                            @if (service.IsActive)
                                            {
                                                <span class="status-badge status-active">
                                                    <i class="bi bi-check-circle-fill"></i>
                                                    Active
                                                </span>
                                            }
                                            else
                                            {
                                                <span class="status-badge status-inactive">
                                                    <i class="bi bi-x-circle-fill"></i>
                                                    Inactive
                                                </span>
                                            }
                                        </td>
                                        <td>
                                            <div class="date-cell">
                                                <i class="bi bi-calendar"></i>
                                                @service.DateAdded.ToString("MMM dd, yyyy")
                                            </div>
                                        </td>
                                        <td>
                                            <div class="action-buttons">
                                                <a href="@Url.Action("EditService", new { serviceId = service.ServiceId })"
                                                   class="btn-action btn-edit"
                                                   title="Edit Service">
                                                    <i class="bi bi-pencil"></i>
                                                </a>
                                                <button class="btn-action btn-delete remove-service"
                                                        data-service-id="@service.ServiceId"
                                                        title="Remove Service">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    counter++;
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        }
        else
        {
            <!-- Empty State -->
            <div class="empty-state">
                <div class="empty-icon">
                    <i class="bi bi-tools"></i>
                </div>
                <h3 class="empty-title">No Services Yet</h3>
                <p class="empty-description">
                    You haven't added any services yet. Start by adding your first service to attract clients!
                </p>
                <a href="@Url.Action("AddService")" class="btn btn-primary">
                    <i class="bi bi-plus-circle"></i>
                    Add Your First Service
                </a>
            </div>
        }
    </div>
</div>

@section Styles {
    <!-- DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="~/css/myServices.css" />
}

@section Scripts {
    <!-- jQuery (required for DataTables) -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <!-- DataTables JS -->
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>

    @Html.AntiForgeryToken()

    <script>
        $(document).ready(function() {
            // Initialize DataTables
            const table = $('#servicesTable').DataTable({
                "pageLength": 10,
                "lengthMenu": [[5, 10, 25, 50, -1], [5, 10, 25, 50, "All"]],
                "order": [[4, "desc"]], // Sort by date added (newest first)
                "language": {
                    "search": "Search services:",
                    "lengthMenu": "Show _MENU_ services",
                    "info": "Showing _START_ to _END_ of _TOTAL_ services",
                    "infoEmpty": "No services available",
                    "infoFiltered": "(filtered from _MAX_ total services)",
                    "zeroRecords": "No matching services found",
                    "paginate": {
                        "first": "First",
                        "last": "Last",
                        "next": "Next",
                        "previous": "Previous"
                    }
                },
                "columnDefs": [
                    { "orderable": false, "targets": [3, 6] } // Disable sorting for Price and Actions columns
                ],
                "dom": '<"table-controls"<"table-controls-left"l><"table-controls-right"f>>rtip'
            });

            // Update price on blur
            $(document).on('blur', '.price-input', async function() {
                const $input = $(this);
                const serviceId = $input.data('service-id');
                const price = parseFloat($input.val());

                if (price > 0) {
                    $input.addClass('updating');

                    const formData = new FormData();
                    formData.append('serviceId', serviceId);
                    formData.append('pricePerHour', price);
                    formData.append('__RequestVerificationToken', $('input[name="__RequestVerificationToken"]').val());

                    try {
                        const response = await fetch('@Url.Action("UpdateServicePrice")', {
                            method: 'POST',
                            body: formData
                        });

                        $input.removeClass('updating');

                        if (response.ok) {
                            $input.addClass('success');
                            setTimeout(() => $input.removeClass('success'), 2000);

                            // Show success notification
                            showNotification('Price updated successfully!', 'success');
                        } else {
                            $input.addClass('error');
                            setTimeout(() => $input.removeClass('error'), 2000);
                            showNotification('Failed to update price', 'error');
                        }
                    } catch (error) {
                        $input.removeClass('updating');
                        $input.addClass('error');
                        setTimeout(() => $input.removeClass('error'), 2000);
                        showNotification('An error occurred', 'error');
                    }
                }
            });

            // Remove service
            $(document).on('click', '.remove-service', async function() {
                const $btn = $(this);
                const serviceId = $btn.data('service-id');

                if (!confirm('Are you sure you want to remove this service? This action cannot be undone.')) {
                    return;
                }

                $btn.prop('disabled', true);
                $btn.html('<i class="bi bi-hourglass-split"></i>');

                const formData = new FormData();
                formData.append('serviceId', serviceId);
                formData.append('__RequestVerificationToken', $('input[name="__RequestVerificationToken"]').val());

                try {
                    const response = await fetch('@Url.Action("RemoveService")', {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();

                    if (result.success) {
                        // Remove row from DataTable
                        table.row($btn.closest('tr')).remove().draw();
                        showNotification('Service removed successfully!', 'success');

                        // Reload page if no services left
                        if (table.rows().count() === 0) {
                            setTimeout(() => location.reload(), 1000);
                        }
                    } else {
                        $btn.prop('disabled', false);
                        $btn.html('<i class="bi bi-trash"></i>');
                        showNotification(result.message || 'Failed to remove service', 'error');
                    }
                } catch (error) {
                    $btn.prop('disabled', false);
                    $btn.html('<i class="bi bi-trash"></i>');
                    showNotification('An error occurred', 'error');
                }
            });

            // Notification system
            function showNotification(message, type) {
                const notification = $(`
                    <div class="notification notification-${type}">
                        <i class="bi bi-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
                        <span>${message}</span>
                    </div>
                `);

                $('body').append(notification);

                setTimeout(() => {
                    notification.addClass('show');
                }, 10);

                setTimeout(() => {
                    notification.removeClass('show');
                    setTimeout(() => notification.remove(), 300);
                }, 3000);
            }

            // Animate cards on page load
            $('.table-card').css({opacity: 0, transform: 'translateY(20px)'});
            setTimeout(() => {
                $('.table-card').css({
                    opacity: 1,
                    transform: 'translateY(0)',
                    transition: 'all 0.6s ease'
                });
            }, 100);
        });
    </script>
}
