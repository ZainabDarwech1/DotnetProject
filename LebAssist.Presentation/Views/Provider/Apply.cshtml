@model LebAssist.Presentation.ViewModels.Provider.ProviderApplicationViewModel
@{
    ViewData["Title"] = "Become a Provider";
}

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0"><i class="bi bi-person-badge"></i> Become a Service Provider</h4>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-4">
                        Join our network of service providers and start earning! Fill out the form below to apply.
                    </p>

                    <form asp-action="Apply" method="post" enctype="multipart/form-data">
                        <div asp-validation-summary="ModelOnly" class="alert alert-danger" role="alert"></div>

                        <!-- Personal Info (Read-only) -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0">Your Information</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Name</label>
                                        <input type="text" class="form-control" value="@Model.FirstName @Model.LastName" readonly />
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Phone</label>
                                        <input type="text" class="form-control" value="@Model.PhoneNumber" readonly />
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Profile Photo -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0">Profile Photo</h5>
                            </div>
                            <div class="card-body">
                                <p class="text-muted small">Upload a professional profile photo (optional but recommended). Max 5MB. Formats: jpg, png, webp</p>
                                <div class="mb-3">
                                    <input type="file" name="ProfilePhoto" accept="image/jpeg,image/png,image/webp" class="form-control" id="profilePhotoInput" />
                                    <span asp-validation-for="ProfilePhoto" class="text-danger"></span>
                                    <div id="profilePhotoPreview" class="mt-2" style="display: none;">
                                        <img id="profilePhotoImg" src="" alt="Preview" style="max-width: 150px; max-height: 150px; object-fit: cover; border-radius: 8px;" />
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Bio & Experience -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0">About You</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label asp-for="Bio" class="form-label">Tell Us About Yourself *</label>
                                    <textarea asp-for="Bio" class="form-control" rows="5"
                                              placeholder="Describe your experience, skills, and why clients should choose you..."></textarea>
                                    <span asp-validation-for="Bio" class="text-danger"></span>
                                    <small class="text-muted">50-500 characters</small>
                                </div>

                                <div class="mb-3">
                                    <label asp-for="YearsOfExperience" class="form-label">Years of Experience *</label>
                                    <input asp-for="YearsOfExperience" type="number" class="form-control" min="0" max="50" style="max-width: 150px;" />
                                    <span asp-validation-for="YearsOfExperience" class="text-danger"></span>
                                </div>
                            </div>
                        </div>

                        <!-- Services Selection -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0">Services You Want to Offer *</h5>
                            </div>
                            <div class="card-body">
                                <p class="text-muted">Select at least one service you can provide:</p>

                                @foreach (var category in Model.ServiceCategories)
                                {
                                    <div class="mb-3">
                                        <h6 class="fw-bold text-primary">@category.CategoryName</h6>
                                        <div class="row">
                                            @foreach (var service in category.Services)
                                            {
                                                <div class="col-md-6 col-lg-4">
                                                    <div class="form-check">
                                                        <input class="form-check-input service-checkbox" 
                                                               type="checkbox"
                                                               name="SelectedServiceIds"
                                                               value="@service.ServiceId"
                                                               id="service-@service.ServiceId"
                                                               data-service-name="@service.ServiceName"
                                                               @(Model.SelectedServiceIds.Contains(service.ServiceId) ? "checked" : "")>
                                                        <label class="form-check-label" for="service-@service.ServiceId">
                                                            @service.ServiceName
                                                        </label>
                                                    </div>
                                                </div>
                                            }
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>

                        <!-- Working Hours per Service -->
                        <div class="card mb-4" id="workingHoursSection" style="display: none;">
                            <div class="card-header">
                                <h5 class="mb-0">Working Hours for Selected Services</h5>
                            </div>
                            <div class="card-body" id="workingHoursContainer">
                                <!-- Dynamic content added by JavaScript -->
                            </div>
                        </div>

                        <!-- Portfolio Photos -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0">Portfolio Photos</h5>
                            </div>
                            <div class="card-body">
                                <p class="text-muted small">Upload photos of your work (optional but recommended). You can add up to 5 photos. Max 5MB each.</p>
                                <div class="mb-3">
                                    <input type="file" name="PortfolioPhotos" accept="image/jpeg,image/png,image/webp" multiple class="form-control" id="portfolioPhotosInput" />
                                    <span asp-validation-for="PortfolioPhotos" class="text-danger"></span>
                                </div>
                                <div id="portfolioPreviewContainer" class="row mt-3"></div>
                            </div>
                        </div>

                        <!-- Terms -->
                        <div class="form-check mb-4">
                            <input class="form-check-input" type="checkbox" id="agreeTerms" required>
                            <label class="form-check-label" for="agreeTerms">
                                I agree to the <a href="#" data-bs-toggle="modal" data-bs-target="#termsModal">Terms of Service</a> for providers
                            </label>
                        </div>

                        <!-- Submit -->
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="bi bi-send"></i> Submit Application
                            </button>
                            <a asp-controller="Home" asp-action="Index" class="btn btn-outline-secondary">
                                Cancel
                            </a>
                        </div>
                    </form>
                </div>
            </div>

            <!-- What Happens Next -->
            <div class="card mt-4">
                <div class="card-body">
                    <h5><i class="bi bi-info-circle text-info"></i> What Happens Next?</h5>
                    <ol class="mb-0">
                        <li>Your application will be reviewed by our team</li>
                        <li>You'll receive a notification once approved (usually within 24-48 hours)</li>
                        <li>After approval, you can start accepting bookings and emergency requests</li>
                        <li>You'll be able to update your services, working hours, and pricing anytime</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Terms Modal -->
<div class="modal fade" id="termsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Provider Terms of Service</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>By becoming a provider on LebAssist, you agree to:</p>
                <ul>
                    <li>Provide accurate information about your skills and experience</li>
                    <li>Respond to booking requests in a timely manner</li>
                    <li>Deliver quality service to all clients</li>
                    <li>Maintain professional conduct at all times</li>
                    <li>Keep your availability status updated</li>
                    <li>Not share customer information with third parties</li>
                    <li>Report any issues or disputes within 48 hours</li>
                </ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">I Understand</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];

        // Handle service checkbox changes
        document.querySelectorAll('.service-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', updateWorkingHours);
        });

        // Update working hours section when services are selected
        function updateWorkingHours() {
            const selectedServices = Array.from(document.querySelectorAll('.service-checkbox:checked'))
                .map(cb => ({
                    serviceId: cb.value,
                    serviceName: cb.dataset.serviceName
                }));

            const container = document.getElementById('workingHoursContainer');
            const section = document.getElementById('workingHoursSection');

            if (selectedServices.length === 0) {
                section.style.display = 'none';
                return;
            }

            section.style.display = 'block';
            container.innerHTML = '';

            selectedServices.forEach(service => {
                const serviceHtml = `
                    <div class="card mb-3 border-info">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">Working Hours - ${service.serviceName}</h6>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Day</th>
                                            <th>Working</th>
                                            <th>Start Time</th>
                                            <th>End Time</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${days.map((day, index) => `
                                            <tr>
                                                <td>${day}</td>
                                                <td>
                                                    <input type="checkbox" 
                                                           class="form-check-input day-checkbox" 
                                                           name="isDay_${service.serviceId}_${index}"
                                                           data-service-id="${service.serviceId}" 
                                                           data-day="${index}"
                                                           value="on">
                                                </td>
                                                <td>
                                                    <input type="time" 
                                                           class="form-control form-control-sm" 
                                                           name="startTime_${service.serviceId}_${index}"
                                                           value="09:00"
                                                           data-service-id="${service.serviceId}" 
                                                           data-day="${index}"
                                                           data-type="start"
                                                           disabled>
                                                </td>
                                                <td>
                                                    <input type="time" 
                                                           class="form-control form-control-sm" 
                                                           name="endTime_${service.serviceId}_${index}"
                                                           value="17:00"
                                                           data-service-id="${service.serviceId}" 
                                                           data-day="${index}"
                                                           data-type="end"
                                                           disabled>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', serviceHtml);
            });

            // Enable/disable time inputs based on checkbox
            document.querySelectorAll('.day-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', function () {
                    const serviceId = this.dataset.serviceId;
                    const day = this.dataset.day;
                    const startInput = document.querySelector(`input[name="startTime_${serviceId}_${day}"]`);
                    const endInput = document.querySelector(`input[name="endTime_${serviceId}_${day}"]`);
                    startInput.disabled = !this.checked;
                    endInput.disabled = !this.checked;
                });
            });
        }

        // Profile photo preview
        document.getElementById('profilePhotoInput').addEventListener('change', function (e) {
            const preview = document.getElementById('profilePhotoPreview');
            const img = document.getElementById('profilePhotoImg');
            const file = e.target.files[0];

            if (file) {
                const reader = new FileReader();
                reader.onload = function (event) {
                    img.src = event.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            } else {
                preview.style.display = 'none';
            }
        });

        // Portfolio photos preview
        document.getElementById('portfolioPhotosInput').addEventListener('change', function (e) {
            const container = document.getElementById('portfolioPreviewContainer');
            container.innerHTML = '';
            const files = e.target.files;

            if (files.length > 5) {
                alert('You can upload a maximum of 5 photos.');
                this.value = '';
                return;
            }

            Array.from(files).forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = function (event) {
                    const col = document.createElement('div');
                    col.className = 'col-md-6 col-lg-4 mb-3';
                    col.innerHTML = `
                        <div class="position-relative" style="border-radius: 8px; overflow: hidden;">
                            <img src="${event.target.result}" class="img-fluid" style="max-height: 150px; width: 100%; object-fit: cover;" />
                            <small class="badge bg-secondary position-absolute bottom-0 start-0 m-2">#${index + 1}</small>
                        </div>
                    `;
                    container.appendChild(col);
                };
                reader.readAsDataURL(file);
            });
        });
    </script>
}