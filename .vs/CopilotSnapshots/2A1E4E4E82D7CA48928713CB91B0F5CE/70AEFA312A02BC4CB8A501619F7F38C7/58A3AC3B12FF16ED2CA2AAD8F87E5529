using Domain.Entities;
using Domain.Interfaces;
using LebAssist.Application.DTOs;
using LebAssist.Application.Interfaces;
using Microsoft.EntityFrameworkCore;
using Microsoft.Extensions.Logging;

namespace LebAssist.Application.Services
{
    public class CategoryService : ICategoryService
    {
        private readonly IUnitOfWork _unitOfWork;
        private readonly IFileStorageService _fileStorageService;
        private readonly ILogger<CategoryService> _logger;

        public CategoryService(
            IUnitOfWork unitOfWork,
            IFileStorageService fileStorageService,
            ILogger<CategoryService> logger)
        {
            _unitOfWork = unitOfWork;
            _fileStorageService = fileStorageService;
            _logger = logger;
        }

        public async Task<IEnumerable<CategoryDto>> GetAllCategoriesAsync()
        {
            var categories = await _unitOfWork.Categories.GetAllAsync();

            return categories.Select(c => new CategoryDto
            {
                CategoryId = c.CategoryId,
                CategoryName = c.CategoryName,
                Description = c.Description,
                IconPath = c.IconPath,
                IsActive = c.IsActive,
                DisplayOrder = c.DisplayOrder,
                ServiceCount = c.Services.Count
            }).OrderBy(c => c.DisplayOrder);
        }

        public async Task<IEnumerable<CategoryDto>> GetActiveCategoriesAsync()
        {
            var categories = await _unitOfWork.Categories.GetActiveCategoriesAsync();

            return categories.Select(c => new CategoryDto
            {
                CategoryId = c.CategoryId,
                CategoryName = c.CategoryName,
                Description = c.Description,
                IconPath = c.IconPath,
                IsActive = c.IsActive,
                DisplayOrder = c.DisplayOrder,
                ServiceCount = c.Services.Count(s => s.IsActive)
            }).OrderBy(c => c.DisplayOrder);
        }

        public async Task<CategoryDto?> GetCategoryByIdAsync(int categoryId)
        {
            var category = await _unitOfWork.Categories.GetByIdAsync(categoryId);
            if (category == null)
                return null;

            return new CategoryDto
            {
                CategoryId = category.CategoryId,
                CategoryName = category.CategoryName,
                Description = category.Description,
                IconPath = category.IconPath,
                IsActive = category.IsActive,
                DisplayOrder = category.DisplayOrder,
                ServiceCount = category.Services.Count
            };
        }

        public async Task<CategoryWithServicesDto?> GetCategoryWithServicesAsync(int categoryId)
        {
            var category = await _unitOfWork.Categories.GetCategoryWithServicesAsync(categoryId);
            if (category == null)
                return null;

            return new CategoryWithServicesDto
            {
                CategoryId = category.CategoryId,
                CategoryName = category.CategoryName,
                Description = category.Description,
                IconPath = category.IconPath,
                IsActive = category.IsActive,
                Services = category.Services.Select(s => new ServiceDto
                {
                    ServiceId = s.ServiceId,
                    CategoryId = s.CategoryId,
                    CategoryName = category.CategoryName,
                    ServiceName = s.ServiceName,
                    ServiceDescription = s.ServiceDescription,
                    IsActive = s.IsActive,
                    ServiceIconPath = s.ServiceIconPath
                }).ToList()
            };
        }

        public async Task<int> CreateCategoryAsync(CreateCategoryDto dto)
        {
            try
            {
                string? iconPath = null;
                if (dto.IconData != null && !string.IsNullOrEmpty(dto.IconFileName))
                {
                    if (_fileStorageService.ValidateImageFile(dto.IconFileName, dto.IconData.Length))
                    {
                        iconPath = await _fileStorageService.SaveFileAsync(dto.IconData, dto.IconFileName, "categories");
                    }
                }

                var category = new ServiceCategory
                {
                    CategoryName = dto.CategoryName,
                    Description = dto.Description,
                    IconPath = iconPath,
                    IsActive = true,
                    DisplayOrder = dto.DisplayOrder
                };

                await _unitOfWork.Categories.AddAsync(category);
                await _unitOfWork.SaveChangesAsync();

                _logger.LogInformation("Category created with ID {CategoryId}", category.CategoryId);
                return category.CategoryId;
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error creating category {CategoryName}", dto.CategoryName);
                throw;
            }
        }

        public async Task<bool> UpdateCategoryAsync(int categoryId, UpdateCategoryDto dto)
        {
            try
            {
                var category = await _unitOfWork.Categories.GetByIdAsync(categoryId);
                if (category == null)
                    return false;

                if (dto.IconData != null && !string.IsNullOrEmpty(dto.IconFileName))
                {
                    if (_fileStorageService.ValidateImageFile(dto.IconFileName, dto.IconData.Length))
                    {
                        if (!string.IsNullOrEmpty(category.IconPath))
                        {
                            await _fileStorageService.DeleteFileAsync(category.IconPath);
                        }

                        category.IconPath = await _fileStorageService.SaveFileAsync(
                            dto.IconData,
                            dto.IconFileName,
                            "categories");
                    }
                }

                category.CategoryName = dto.CategoryName;
                category.Description = dto.Description;
                category.DisplayOrder = dto.DisplayOrder;

                _unitOfWork.Categories.Update(category);
                await _unitOfWork.SaveChangesAsync();

                _logger.LogInformation("Category updated with ID {CategoryId}", categoryId);
                return true;
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error updating category {CategoryId}", categoryId);
                return false;
            }
        }

        public async Task<bool> DeleteCategoryAsync(int categoryId)
        {
            try
            {
                var category = await _unitOfWork.Categories.GetByIdAsync(categoryId);
                if (category == null)
                    return false;

                if (category.Services.Any())
                {
                    _logger.LogWarning("Cannot delete category {CategoryId} because it has services", categoryId);
                    return false;
                }

                if (!string.IsNullOrEmpty(category.IconPath))
                {
                    await _fileStorageService.DeleteFileAsync(category.IconPath);
                }

                _unitOfWork.Categories.Delete(category);
                await _unitOfWork.SaveChangesAsync();

                _logger.LogInformation("Category deleted with ID {CategoryId}", categoryId);
                return true;
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error deleting category {CategoryId}", categoryId);
                return false;
            }
        }

        public async Task<bool> ToggleCategoryStatusAsync(int categoryId)
        {
            try
            {
                var category = await _unitOfWork.Categories.GetByIdAsync(categoryId);
                if (category == null)
                    return false;

                category.IsActive = !category.IsActive;
                _unitOfWork.Categories.Update(category);
                await _unitOfWork.SaveChangesAsync();

                _logger.LogInformation("Category {CategoryId} status toggled to {IsActive}", categoryId, category.IsActive);
                return true;
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error toggling category status {CategoryId}", categoryId);
                return false;
            }
        }
    }
}
